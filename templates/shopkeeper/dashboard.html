{% extends "base.html" %}

{% block title %}Shopkeeper Dashboard{% endblock %}

{% block content %}
<div style="background: white; padding: 20px; margin: 20px; border-radius: 10px; min-height: 500px;">
    <div class="dashboard-header" style="border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">
        <h1 style="color: #333; margin-bottom: 10px;">üõçÔ∏è Shopkeeper Dashboard</h1>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <p style="color: #666;">Welcome, {{ shopkeeper.name }}!</p>
            <div style="display: flex; gap: 15px; align-items: center;">
                <button onclick="showProductsModal()" style="background: #17a2b8; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                    üõçÔ∏è Products <span class="badge" style="background: #fff; color: #17a2b8; padding: 2px 6px; border-radius: 10px; font-size: 12px;">{{ products|length }}</span>
                </button>
                <button onclick="showOrdersModal()" style="background: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                    üìã Orders <span class="badge" style="background: #fff; color: #007bff; padding: 2px 6px; border-radius: 10px; font-size: 12px;">{{ pending_orders_count }}</span>
                </button>
                <a href="{% url 'logout' %}" style="background: #dc3545; color: white; padding: 8px 16px; text-decoration: none; border-radius: 5px;">Logout</a>
            </div>
        </div>
    </div>

    <!-- Products Modal -->
    <div id="products-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
        <div style="position: relative; max-width: 1000px; margin: 30px auto; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
            <div style="position: sticky; top: 0; background: white; padding: 20px; border-bottom: 1px solid #eee; z-index: 10;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #333;">üõçÔ∏è Your Products</h2>
                    <button onclick="closeProductsModal()" style="background: #dc3545; color: white; border: none; border-radius: 5px; width: 30px; height: 30px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;">√ó</button>
                </div>
                
                <!-- Search Bar -->
                <div style="position: relative; margin-bottom: 15px;">
                    <input type="text" id="product-search" placeholder="Search products..." 
                           style="width: 100%; padding: 10px 15px 10px 40px; border: 1px solid #ddd; border-radius: 25px; font-size: 14px;"
                           onkeyup="filterProducts()">
                    <span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #6c757d;">
                        üîç
                    </span>
                </div>
            </div>
            
            <div style="padding: 0 20px 20px 20px;">
                {% if products %}
                    <div id="products-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        {% for product in products %}
                        <div class="product-item" data-name="{{ product.name|lower }}" data-description="{{ product.description|lower }}" 
                             style="border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; background: white;">
                            {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                                 style="width: 100%; height: 180px; object-fit: cover; border-bottom: 1px solid #eee;">
                            {% else %}
                            <div style="width: 100%; height: 180px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #999; border-bottom: 1px solid #eee;">
                                No Image Available
                            </div>
                            {% endif %}
                            <div style="padding: 15px;">
                                <h4 style="margin: 0 0 10px 0; color: #333; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="{{ product.name }}">
                                    {{ product.name }}
                                </h4>
                                <p style="margin: 5px 0; color: #28a745; font-weight: bold;">‚Çπ{{ product.price }}</p>
                                <p style="margin: 5px 0; color: #6c757d; font-size: 14px;">Qty: {{ product.quantity }}</p>
                                <div style="display: flex; gap: 10px; margin-top: 12px;">
                                    <a href="{% url 'edit_product' product.id %}" 
                                       style="flex: 1; background: #17a2b8; color: white; text-align: center; padding: 6px 0; border-radius: 4px; text-decoration: none; font-size: 14px; transition: background 0.2s;">
                                        Edit
                                    </a>
                                    <form method="post" action="{% url 'delete_product' product.id %}" style="flex: 1; margin: 0;">
                                        {% csrf_token %}
                                        <button type="submit" 
                                                style="width: 100%; background: #dc3545; color: white; border: none; border-radius: 4px; padding: 6px 0; font-size: 14px; cursor: pointer; transition: background 0.2s;"
                                                onclick="return confirm('Are you sure you want to delete this product?')">
                                            Delete
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üì¶</div>
                        <h3 style="color: #6c757d; margin-bottom: 10px;">No Products Yet</h3>
                        <p style="color: #6c757d; margin-bottom: 20px;">You haven't added any products yet. Start by adding your first product!</p>
                    </div>
                {% endif %}
            </div>
            
            <div style="padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #eee; display: flex; justify-content: flex-end;">
                <button onclick="closeProductsModal()" style="background: #6c757d; color: white; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer;">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Products modal functions
        function showProductsModal() {
            document.getElementById('products-modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            // Focus on search input when modal opens
            setTimeout(() => {
                const searchInput = document.getElementById('product-search');
                if (searchInput) searchInput.focus();
            }, 100);
        }

        function closeProductsModal() {
            document.getElementById('products-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
            // Clear search when closing
            const searchInput = document.getElementById('product-search');
            if (searchInput) searchInput.value = '';
            filterProducts(); // Reset filter
        }

        // Filter products based on search input
        function filterProducts() {
            const searchTerm = document.getElementById('product-search').value.toLowerCase();
            const products = document.querySelectorAll('.product-item');
            
            products.forEach(product => {
                const name = product.getAttribute('data-name');
                const description = product.getAttribute('data-description') || '';
                const matchesSearch = name.includes(searchTerm) || description.includes(searchTerm);
                product.style.display = matchesSearch ? 'block' : 'none';
            });
        }

        // Close modal when clicking outside the content
        window.onclick = function(event) {
            const modal = document.getElementById('products-modal');
            if (event.target === modal) {
                closeProductsModal();
            }
        };

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeProductsModal();
            }
        });
    </script>

    <!-- Add Product Form -->
    <div style="margin-bottom: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
        <h2 style="color: #333; margin-bottom: 15px;">Add New Product</h2>
        <form method="post" action="{% url 'add_product' %}" enctype="multipart/form-data" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            {% csrf_token %}
            <div>
                <label style="display: block; margin-bottom: 5px; color: #333;">Product Name</label>
                <input type="text" name="name" placeholder="Enter product name" required 
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <div>
                <label style="display: block; margin-bottom: 5px; color: #333;">Price (‚Çπ)</label>
                <input type="number" name="price" placeholder="Enter price" min="1" step="0.01" required
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <div>
                <label style="display: block; margin-bottom: 5px; color: #333;">Quantity</label>
                <input type="text" name="quantity" placeholder="e.g., 1kg, 500ml, 10 pieces" required
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <div>
                <label style="display: block; margin-bottom: 5px; color: #333;">Product Image</label>
                <input type="file" name="image" accept="image/*"
                       style="width: 100%; padding: 8px 0;">
                <p style="font-size: 12px; color: #6c757d; margin: 5px 0 0 0;">Upload product image (optional)</p>
            </div>
            
            <div style="grid-column: 1 / -1;">
                <label style="display: block; margin-bottom: 5px; color: #333;">Description</label>
                <textarea name="description" placeholder="Enter product description" rows="3"
                          style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
            </div>
            
            <div style="grid-column: 1 / -1;">
                <button type="submit" style="background: #28a745; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; flex: 1;">
                    ‚ûï Add Product
                </button>
            </div>
        </form>
    </div>
    
    <!-- Orders Section -->
    <button onclick="showOrdersModal()" style="background: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer;">
        üìã Orders 
        <span style="background: #fff; color: #007bff; padding: 2px 6px; border-radius: 10px; font-size: 12px;">{{ pending_orders_count }}</span>
    </button>

    <!-- Orders Modal -->
    <div id="orders-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 700px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #333;">üìã Your Orders</h3>
                <button onclick="closeOrdersModal()" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">√ó</button>
            </div>

            {% if orders %}
                <div id="orders-container" style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                    {% for order in orders %}
                    <div class="order-item" style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9;">
                        <h3 style="color: #333;">Order #{{ order.id }}</h3>
                        <p><strong>Status:</strong> 
                            <span id="order-status-{{ order.id }}" style="padding: 4px 8px; border-radius: 4px; background: 
                                {% if order.status == 'pending' %}#ffc107{% elif order.status == 'confirmed' %}#007bff{% elif order.status == 'ready' %}#28a745{% elif order.status == 'delivered' %}#6c757d{% else %}#dc3545{% endif %};
                                color: {% if order.status == 'pending' %}black{% else %}white{% endif %}; font-size: 0.9em;">
                                {{ order.status|title }}
                            </span>
                        </p>
                        {% if order.status == 'pending' %}
                            <button id="mark-ready-btn-{{ order.id }}" onclick="markAsReady({{ order.id }})" style="background: #28a745; color: white; border: none; border-radius: 5px; padding: 6px 12px; cursor: pointer; margin-top: 5px;">
                                Mark as Ready
                            </button>
                        {% endif %}
                        <p><strong>Date:</strong> {{ order.date|date:"M d, Y" }}</p>
                        <p><strong>Total:</strong> ‚Çπ{{ order.total_amount }}</p>

                        <h4>Items:</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in order.items.all %}
                                <tr>
                                    <td>{{ item.product_name|default:item.product.name|default:"[Deleted Product]" }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td>‚Çπ{{ item.price }}</td>
                                    <td>‚Çπ{{ item.subtotal|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
                    <p style="color: #666; font-size: 18px;">No orders yet. When customers place orders, they will appear here.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        function showOrdersModal() {
            document.getElementById('orders-modal').style.display = 'block';
        }

        function closeOrdersModal() {
            document.getElementById('orders-modal').style.display = 'none';
        }

        // Auto-scroll functionality for orders
        function autoScrollOrders() {
            const ordersContainer = document.getElementById('orders-container');
            if (ordersContainer) {
                ordersContainer.scrollTop = ordersContainer.scrollHeight;
            }
        }

        // Initialize auto-scroll when page loads
        document.addEventListener('DOMContentLoaded', function() {
            autoScrollOrders();
        });

        // Refresh orders every 30 seconds
        setInterval(function() {
            // This would typically make an AJAX call to refresh orders
            console.log('Refreshing orders...');
        }, 30000);

        // Check for bot navigation actions
        document.addEventListener('DOMContentLoaded', function() {
            const action = sessionStorage.getItem('shopkeeperAction');
            if (action) {
                sessionStorage.removeItem('shopkeeperAction'); // Clear after use
                
                // Small delay to ensure page is fully loaded
                setTimeout(() => {
                    switch(action) {
                        case 'showProducts':
                            showProductsModal();
                            break;
                        case 'showOrders':
                            showOrdersModal();
                            break;
                        case 'scrollToAddProduct':
                            // Scroll to add product form
                            const addProductForm = document.querySelector('form[action*="add_product"]');
                            if (addProductForm) {
                                addProductForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                            break;
                    }
                }, 300);
            }
        });

        function markAsReady(orderId) {
            const csrftoken = getCookie('csrftoken');
            fetch(`/shopkeeper/update-order/${orderId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken,
                },
                body: new URLSearchParams({
                    'status': 'ready'
                })
            })
            .then(response => {
                if (response.ok) {
                    // Update status badge
                    const statusSpan = document.getElementById(`order-status-${orderId}`);
                    if (statusSpan) {
                        statusSpan.textContent = 'Ready for Delivery';
                        statusSpan.style.backgroundColor = '#28a745';
                        statusSpan.style.color = 'white';
                    }
                    // Hide the "Mark as Ready" button after update
                    const button = document.querySelector(`#mark-ready-btn-${orderId}`);
                    if (button) {
                        button.style.display = 'none';
                    }
                    alert(`Order #${orderId} marked as ready for delivery.`);
                } else {
                    alert('Failed to update order status.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating order status.');
            });
        }

        // Helper function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</div>
{% endblock %}
